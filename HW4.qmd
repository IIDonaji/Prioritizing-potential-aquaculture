---
title: "Prioritizing-potential-aquaculture"
author: "Ixel"
date: "11/23/2025"
format: 
  pdf:
    fig-pos: "H"
    papersize: landscape
    geometry: margin= 0.5in
    code-fold: false
    toc: true
    number-sections: true
execute:
  #warning: false
  message: false
editor_options: 
  chunk_output_type: console
editor: visual
---
README goes here
What Exclusive Economic Zones (eez) on the west Coast of the US are best suited to developing marine aquaculture for several species of oysters and (choos a species i care about)

# Set-Up

```{r, message=FALSE}
#| output: false

# Load in Libraries
library(here)
library(testthat)
library(tidyverse)
library(sf)
library(kableExtra)
library(spData)
library(spDataLarge)
library(sp)
library(geodata)
library(stars) 
library(tmap)
library(terra)
library(viridisLite)
library(spDataLarge)
```

```{r,message = FALSE}
#| output: false
# Prepare Data

# Bathymetry
depth <- read_stars(here("data/depth.tif"))

# Exclusive Economic Zones (eez)
eez <- st_read(here("data/wc_regions_clean.shp"))

# Sea Surface Temperature (SST) load as a list of .tiff files 
sst <- list.files(path= "data",
                  pattern= "average_annual", # file name matching pattern
                   full.names = TRUE) # Reference entire file name matching this pattern

# Stack all rasters files in folder using rast()
sst <- rast(sst)
names(sst) #checking list
```

Check that the datasets have the same coordinate reference system
```{r, message=FALSE}

# Check and align CRS for multiple datasets
if (st_crs(depth) == st_crs(eez)) {
  print("Coordinate reference system match!")
  
} else{
  warning("CRS mismatch between depth and eez")
  # tranfgotm data to match
  depth <- st_transform(depth, st_crs(eez))

  }
   

if (st_crs(eez)$wkt != crs(sst)) {
  warning("CRS mismatch between eez and sst")
  sst <- project(sst, st_crs(eez)$wkt)  
}
```


# Process data

Next,process the SST and depth data so that they can be combined. In this case the SST and depth data have slightly different resolutions, extents, and positions.

- Find the mean SST from 2008-2012 (e.g. create single raster of average SST) 
  - convert average SST from Kelvin to Celsius hint: subtract by 273.15 
- crop depth raster to match the extent of the SST raster note: 
   - the resolutions of the SST and depth data do not match resample the depth data to match the resolution of the SST data using the nearest neighbor approach 
  - check that the depth and SST match in resolution, extent, and coordinate reference system 
  - hint: can the rasters be stacked?

```{r}
# why lapp?
# Calculate the SST avarage 
mean_sst <- app(sst[[c("average_annual_sst_2008","average_annual_sst_2009", 
                       "average_annual_sst_2010", "average_annual_sst_2011", 
                       "average_annual_sst_2012")]], 
                fun = mean, na.rm = TRUE)

# Convert average SST from Kelvin to Celsius
sst_mean_celsius <- mean_sst - 273.15

# plot
plot(sst_mean_celsius, main= "Mean SST 2008-2012 (°C)")
```

```{r}
# First convert depth stars to SpatRaster
depth_rast <- rast(depth)
# crop depth to match SST  extent
depth_crop <- crop(depth_rast, sst_mean_celsius)

# Resample depth_crop to match SST resolution
depth_resample <- resample(depth_crop, sst_mean_celsius, method = "near")

```

```{r}
# Now check
if (all(dim(depth_resample) == dim(sst_mean_celsius)) &&
    isTRUE(all.equal(res(depth_resample), res(sst_mean_celsius))) &&
    crs(depth_resample) == crs(sst_mean_celsius) &&
    ext(depth_resample) == ext(sst_mean_celsius)) {
  cat("✓ All raster properties match!\n")
} else {
  cat("✗ Some properties do not match\n")
}

# Match depth and SST CRS's
crs(depth_resample) <- crs(sst_mean_celsius)

# Stack
ocean_stack <- c(sst_mean_celsius, depth_resample)
names(ocean_stack) <- c("sst", "depth")
cat("✓ Successfully stacked!\n")
```

# Find suitable locations

To find suitable locations for marine aquaculture, we’ll need to find locations that are suitable in terms of both SST and depth.

reclassify SST and depth data into locations that are suitable for oysters hint: set suitable values to 1 and unsuitable values to 0 find locations that satisfy both SST and depth conditions

```{r}
# Reclassify SST (11-30°C suitable for oysters)
sst_suitable <- app(sst_mean_celsius, fun = function(x){
  ifelse(x >= 11 & x <= 30,1,0) # if temperate is between 11- 30 °C, return 1, els 0
})

# Check results
plot(sst_suitable, main = "Suitable SST Locations (1 = suitable)")
```


```{r}
# Reclassify Suitable depth range (0-70 meters for oysters)
depth_suitable <- app(depth_resample, fun = function(x){
  ifelse(x >= -70 & x <= 0,1,0) # select depths from 0 to 70 meters below surface.
})

# Check result
plot(depth_suitable, main = "Suitable Depth Locations (1 = suitable)") # Return 1 for suitable 0 for unsuitable.
```

```{r}
# Suitable locations for both conditions
# Use lapp() to multiply the two suitability rasters

suitable_locations <- lapp(c(sst_suitable, depth_suitable), 
                           fun = function(sst, depth) {
                             sst * depth
                           })
# Locations with 1 satisfys Both Conditions

# Visualize
plot(suitable_locations, 
     main = "Suitable Locations for Oyster Aquaculture",
     col = c("cornflowerblue", "coral"),
     legend = FALSE)
legend("topright", 
       legend = c("Unsuitable", "Suitable"), 
       fill = c("cornflowerblue", "coral"))

```

```{r}
# Do not need to display table
# Calculate suitable areas Summary statistics
cat("Suitable cells:", global(suitable_locations, "sum", na.rm = TRUE)[1,1], "\n")
cat("Total cells:", global(!is.na(suitable_locations), "sum", na.rm = TRUE)[1,1], "\n")
cat("Percent suitable:", 
    round(100 * global(suitable_locations, "sum", na.rm = TRUE)[1,1] / 
          global(!is.na(suitable_locations), "sum", na.rm = TRUE)[1,1], 2), "%\n")

```

#Determine the most suitable EEZ We want to determine the total suitable area within each EEZ in order to rank zones by priority. To do so, we need to find the total area of suitable locations within each EEZ.

select suitable cells within West Coast EEZs find area of grid cells find the total suitable area within each EEZ hint: it might be helpful to rasterize the EEZ data

```{r}
# Mask suitable locations to EEZ boundaries
suitable_eez <- mask(suitable_locations, eez) # keep only raster cells that fall within the EEZ polygons
 plot(suitable_eez, main = "Suitable Location within EEZ's",
      col = c("white", "darkgreen"))
 plot(st_geometry(eez), add = TRUE, border = "blue", lwd =)
```

```{r}

# Rasterize the EEZ data
eez_raster <- rasterize(eez, suitable_locations, field = "rgn")

# Check the result
plot(eez_raster, main = "EEZ Zones as Raster")
print(eez_raster)
```

```{r}
# Calculate cell area
cell_area_km2 <- cellSize(suitable_locations, unit = "km") # calculate actual area of each raster cell

# Calculate suitable area per cell
suitable_area <- suitable_eez * cell_area_km2

# Sum suitable are by EEZ zone
eez_suitable_area <- zonal(suitable_area, eez_raster, fun = "sum", na.rm = TRUE)
colnames(eez_suitable_area) <- c("eez_id", "suitable_area_km2")

# join with eez data
eez$suitable_area_km2 <- eez_suitable_area$suitable_area_km2[match(eez$rgn, eez_suitable_area$eez_id)]


```

# Reflections

Reflections must be clear, accurate, and demonstrate a deep understanding of the analysis performed

# Cite

Hall, S. J., Delaporte, A., Phillips, M. J., Beveridge, M. & O’Keefe, M. Blue Frontiers: Managing the Environmental Costs of Aquaculture (The WorldFish Center, Penang, Malaysia, 2011).

Gentry, R. R., Froehlich, H. E., Grimm, D., Kareiva, P., Parke, M., Rust, M., Gaines, S. D., & Halpern, B. S. Mapping the global potential for marine aquaculture. Nature Ecology & Evolution, 1, 1317-1324 (2017).︎

GEBCO Compilation Group (2022) GEBCO_2022 Grid (doi:10.5285/e0f0bb80-ab44-2739-e053-6c86abc0289c)
